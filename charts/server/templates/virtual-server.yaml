{{- $config := .Values.config }}
{{- $environment := $config.environment }}
{{- $project := $config.serviceName }}
{{- $host := $config.host | default "stag.xquare.app" }}  # 필요한 경우 기본값 처리
{{- $namespace := printf "%s-%s" $config.serviceName $config.environment }}

# =========================================================================
# prefix 기반 VirtualService
# =========================================================================
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $project }}-{{ $environment }}-ingress
  labels:
    app.kubernetes.io/instance: xquare-ingress
    project: {{ $project }}
  namespace: {{ $namespace }}
spec:
  gateways:
    - istio-system/xquare-ingressgateway
  hosts:
    - {{ $host }}
  http:
    {{- if $config.prefix }}
    - name: {{ $config.serviceName }}
      match:
        - uri:
            prefix: {{ $config.prefix }}
      route:
        - destination:
            {{- $fullname := (printf "%s-%s-%s" $config.serviceName $config.type $config.environment) }}
            host: {{ $fullname }}.{{ $config.clubName }}-{{ $config.environment }}.svc.cluster.local
            port:
              number: {{ $config.containerPort }}
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - POST
          - GET
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowCredentials: true
        allowHeaders:
          - content-type
          - authorization
          - accept
          - accept-encoding
          - Refresh-Token
          - X-Refresh-Token
          - X-Not-Using-Xquare-Auth
          - Oauth-Token
          - oa-token
          - Request-User-Id
          - Request-User-Role
          - x-identifier
        maxAge: "24h"
    {{- end }}

# =========================================================================
# custom domain 기반 VirtualService (domain 이 설정된 경우)
# =========================================================================
{{- if $config.domain }}
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $project }}-{{ $environment }}-domain-ingress
  labels:
    app.kubernetes.io/instance: xquare-ingress
    project: {{ $project }}
  namespace: {{ $namespace }}
spec:
  gateways:
    - istio-system/xquare-ingressgateway
  hosts:
    - {{ $config.domain }}
  http:
    - name: {{ $config.serviceName }}
      route:
        - destination:
            {{- $fullname := (printf "%s-%s-%s" $config.serviceName $config.type $config.environment) }}
            host: '{{ $fullname }}.{{ $config.clubName }}-{{ $config.environment }}.svc.cluster.local'
            port:
              number: {{ $config.containerPort }}
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - POST
          - GET
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowCredentials: true
        allowHeaders:
          - content-type
          - authorization
          - accept
          - accept-encoding
          - Refresh-Token
          - X-Not-Using-Xquare-Auth
          - Oauth-Token
          - oa-token
          - Request-User-Id
          - Request-User-Role
          - X-Refresh-Token
          - x-identifier
        maxAge: "24h"
{{- end }}

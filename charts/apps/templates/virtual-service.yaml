{{- $environment := .Values.spec.environment }}
{{- $project := .Values.spec.project }}
{{- $host := .Values.spec.host }}
{{- $namespace := .Values.spec.namespace }}

# ======================================================================
# custom subdomain 설정 없이
# stag-server 또는 prod-server url 밑에 prefix로 구분 될 서버를 위한 VS
# ======================================================================
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $project }}-{{ $environment }}-ingress
  labels:
    app.kubernetes.io/instance: xquare-ingress
    labels:
      project: {{ $project }}
  namespace: {{ $namespace }}
spec:
  gateways:
    - istio-system/xquare-gateway
  hosts:
    - {{ $host }}
  http:
    {{- range $file := $.Files.Glob (printf "resource/%s/**" $environment) }}
    {{- $yamlData := $file | toString | fromYaml }}
    {{- if and $yamlData $yamlData.config.prefix }}
    - name: {{ $yamlData.config.service_name }}
      match:
      - uri:
          prefix: {{ $yamlData.config.prefix }}
      route:
      - destination:
          {{- $fullname := (printf "%s-%s-%s" $yamlData.config.service_name $yamlData.config.type $yamlData.config.environment) }}
          host: {{ $fullname }}
          port:
            number: {{ $yamlData.config.containerPort }}
      corsPolicy:
        allowOrigins:
        - prefix: https://service.xquare.app
        - prefix: https://admin.xquare.app
        - prefix: https://admin.dsm-pick.com
        - prefix: https://teacher.dsm-pick.com
        - prefix: https://keeper.dsm-pick.com
        - prefix: http://localhost:3000
        - prefix: http://localhost:3001
        allowMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        allow_headers:
        - content-type
        - authorization
        - accept
        - accept-encoding
        - Refresh-Token
        - X-Not-Using-Xquare-Auth
        expose_headers:
        - Access-Control-Allow-Credentials
    {{- end }}
    {{- end }}


# ======================================================================
# custom subdomain이 사용될 서버를 위한 VS
# ======================================================================
{{- range $file := $.Files.Glob (printf "resource/%s/**" $environment) }}
{{- $yamlData := $file | toString | fromYaml }}
{{- if and $yamlData $yamlData.config.domain }}
---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $project }}-{{ $environment }}-{{ $yamlData.config.service_name }}-domain-ingress
  labels:
    app.kubernetes.io/instance: xquare-ingress
    labels:
      project: {{ $project }}
  namespace: {{ $namespace }}
spec:
  gateways:
    - istio-system/xquare-gateway
  hosts:
    - {{ $yamlData.config.domain }}
  http:
    - name: {{ $yamlData.config.service_name }}
      route:
      - destination:
          {{- $fullname := (printf "%s-%s-%s" $yamlData.config.service_name $yamlData.config.type $yamlData.config.environment) }}
          host: {{ $fullname }}
          port:
            number: 80
      corsPolicy:
        allowOrigins:
        - prefix: https://service.xquare.app
        - prefix: https://admin.xquare.app
        - prefix: https://admin.dsm-pick.com
        - prefix: https://teacher.dsm-pick.com
        - prefix: https://keeper.dsm-pick.com
        - prefix: http://localhost:3000
        - prefix: http://localhost:3001
        allowMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        allow_headers:
        - content-type
        - authorization
        - accept
        - accept-encoding
        - Refresh-Token
        - X-Not-Using-Xquare-Auth
        expose_headers:
        - Access-Control-Allow-Credentials
{{- end }}
{{- end }}

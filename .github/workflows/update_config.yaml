name: Update Config
on:
  repository_dispatch:
    types: 
      - update_config
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out The Repository
        uses: actions/checkout@v2

      - name: Set Payload Aliases
        id: set_payload
        run: |
          echo "service_name=${{ github.event.client_payload.service_name }}" >> $GITHUB_ENV
          echo "service_prefix=${{ github.event.client_payload.service_prefix }}" >> $GITHUB_ENV
          echo "image_tag=${{ github.event.client_payload.image_tag }}" >> $GITHUB_ENV
          echo "environment=${{ github.event.client_payload.environment }}" >> $GITHUB_ENV
          echo "service_type=${{ github.event.client_payload.service_type }}" >> $GITHUB_ENV

      - name: Get config file path
        id: config-file
        run: |
          config_file_path="${GITHUB_WORKSPACE}/charts/apps/resource/${{ env.environment }}/${{ env.service_name }}-${{ env.service_type }}/resource.yaml"
          touch $config_file_path
          echo "config_file_path=$config_file_path" >> $GITHUB_OUTPUT

      - name: Use yq to modify Config file
        if: ${{ env.service_name && env.service_prefix && env.image_tag && env.environment && env.service_type }}
        uses: mikefarah/yq@v4
        with:
          args: yq -i "
                .config.service_name = "${{ env.service_name }}" |
                .config.prefix = "${{ env.service_prefix }}" |
                .config.imageTag = "${{ env.image_tag }}" |
                .config.containerPort = 8080 |
                .config.environment = "${{ env.environment }}" |
                .config.type = "${{ env.service_type }}" |
              " ${{ steps.config-file.outputs.config_file_path }}
      
      - name: Commit The New Image Reference
        if: ${{ env.service_name && env.service_prefix && env.image_tag && env.environment && env.service_type }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸš€ :: ${{ env.service_name }}-${{ env.service_type }}-${{ env.environment }}: Deploy new image ${{ env.version }}"
          branch: master
          commit_options: '--no-verify --signoff'
          repository: .
          commit_user_name: XQUARE GitOps Bot
          commit_user_email: teamxquare@gmail.com
          commit_author: XQUARE GitOps Bot <teamxquare@gmail.com>
